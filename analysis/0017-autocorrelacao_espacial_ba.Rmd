---
title: "Técnicas para Verificação da Autocorrelação Espacial (cont)"
author: "Rafael Vinicius Curiel"
date: "10/02/2022"
output: html_document
---

## Pacotes e comandos

Carregamento dos pacotes  
```{r message=FALSE, warning=FALSE}
pacotes <- c("tidyverse","rgdal","spdep","knitr","kableExtra","tmap","gtools")
sapply(pacotes, require, character = T) 
```


## Carregamento do objeto

Carregamento da base de dados
```{r message=FALSE, warning=FALSE}
shp_ba <- rgdal::readOGR(dsn = "D:/datasets/shapefile_ba", layer = "ba_state", encoding = "UTF-8", use_iconv = TRUE)
load("D:/datasets/dados_ba.RData")
```



### Manipulação

União das bases de dados
```{r}
shp_ba@data %>% 
  dplyr::left_join(dados_ba, by = "Codigo") -> shp_ba@data
```


Estabelecimento do critério de vizinhança (distância geográfica) de 90km:
```{r}
nb_distan <- spdep::dnearneigh(coordinates(shp_ba), d1 = 0, d2 = 90, longlat = TRUE)
```


Matriz W:
```{r}
w_matrix_distan <- spdep::nb2mat(neighbours = nb_distan, style = "B")

colnames(w_matrix_distan) <- shp_ba@data$MUNICIPIO
rownames(w_matrix_distan) <- shp_ba@data$MUNICIPIO
```


Alteração do tipo do objeto (de Matrizw para Listw):
```{r}
w_list_distan <- spdep::mat2listw(x = w_matrix_distan)
```


### Autocorrelação Local - Estatística G de Getis e Ord

Estatística G de Getis e Ord:
```{r}
g_local <- spdep::localG(x = shp_ba@data$idh, listw = w_list_distan)
```


União do objeto g_local ao shapefile:
```{r}
mapa_G <- base::cbind(shp_ba, as.matrix(g_local)) 

mapa_G@data %>% 
  dplyr::rename(estistica_g = 4) -> mapa_G@data

utils::head(mapa_G@data)
```


### Visualização

```{r}
mapa_G@data <- mapa_G@data %>% 
  dplyr::mutate(faixa_quantis = factor(quantcut(x = estistica_g, q = 4))) 

tm_shape(mapa_G) + 
  tm_fill("faixa_quantis", palette = "RdBu", title = "Faixas Quantis") + 
  tm_layout(main.title.size = 0.83,
            main.title = "Autocorrelação Local pela Estatística G de Getis e Ord\nIDH no Estado da Bahia",
            main.title.position = 'center') +
  tm_borders()
```

