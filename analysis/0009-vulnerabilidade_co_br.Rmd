---
title: "Distribuição da Vulnerabilidade na Região Centro-Oeste do Brasil"
author: "Rafael Vinicius Curiel"
date: "30/01/2022"
output: html_document
---

## Pacotes e comandos

Carregamento dos pacotes  
```{r message=FALSE, warning=FALSE}
pacotes <- c("rgdal","tidyverse","knitr","kableExtra","gridExtra",
             "png","grid","magick","rgl","devtools","GISTools","rayshader",
             "tmap","broom", "sp")
sapply(pacotes, require, character = T) 
```


## Carregamento do objeto

Carregamento da base de dados
```{r message=FALSE, warning=FALSE}
shp_centro_oeste <- readOGR(dsn = "D:\\datasets\\shapefile_centrooeste", 
                            layer = "centrooeste_shapefile",
                            encoding = "UTF8")
```



### Exploração

Visão estrutural:
```{r}
head(shp_centro_oeste@data, 10)
```


Visualização gráfica preliminar
```{r}
tm_shape(shp = shp_centro_oeste) + 
  tm_borders()
```


### Visualização

Transformação do shapefile em dataframe (para aplicação do ggplot2 )
```{r message=FALSE, warning=FALSE}
shp_centro_oeste_df <- tidy(shp_centro_oeste, region = "CD_GEOCODM") %>% 
  rename(CD_GEOCODM = id) %>% 
  mutate(state = substr(x = group, start = 1, stop = 2),
         state = factor(state,
                        levels = c("50", "51", "52", "53"),
                        labels = c("MS", "MT", "GO", "DF")),
         city_cod = substr(x = group, start = 1, stop = 7)) %>% 
  left_join(shp_centro_oeste@data,
           by = "CD_GEOCODM") %>% 
  rename(city = NM_MUNICIP)
```


Visualização gráfica preliminar:
```{r}
shp_centro_oeste_df %>% 
    ggplot() +
    geom_polygon(aes(x = long, 
                     y = lat, 
                     group = group, 
                     fill = state, 
                     label = city),
                 color = "black") +
    labs(x = "Longitude",
         y = "Latitude",
         fill = "State",
         title = "Distribuição dos Estados do Centro-Oeste do Brasil") +
    scale_fill_viridis_d(option = "viridis") +
    theme_bw()
```



### Manipulação - Dados Complementares (vulnerabilidade)

Carregamento de dados complementares e união com base de dados shapefile:
```{r}
load("D:\\datasets\\dados_centro_oeste.RData")

shp_centro_oeste_dados <- merge(x = shp_centro_oeste,
                                y = dados_centro_oeste,
                                by.x = "CD_GEOCODM",
                                by.y = "CD_GEOCODM")
```


## Visualização gráfica da variável de interesse (tmap):
```{r}
tm_shape(shp = shp_centro_oeste_dados) + 
  tm_fill(col = "poverty", 
          style = "quantile", 
          n = 4, 
          palette = "-viridis", 
          legend.hist = TRUE,
          title = "Taxa de Pobreza") +
  tm_borders(alpha = 0.8) +
  tm_compass() +
  tm_layout(legend.outside = TRUE,
            main.title = "Dist. da Vulnerabilidade Social no CO do Brasil")
```


## Visualização gráfica da variável de interesse (ggplot2):

Réplica das faixas estabelecidas no tmap:
```{r message=FALSE, warning=FALSE}
shp_centro_oeste_df <- tidy(shp_centro_oeste_dados, region = "CD_GEOCODM") %>% 
  rename(CD_GEOCODM = id) %>% 
  left_join(shp_centro_oeste_dados@data, by = "CD_GEOCODM")

shp_centro_oeste_df <- shp_centro_oeste_df %>% 
  mutate(poverty_bands = ifelse(test = poverty <= 25.40, 
                                yes = "7.84 to 25.40",
                                no = ifelse(test = poverty > 25.40 & poverty <= 31.80,
                                            yes = "25.41 to 31.80",
                                            no = ifelse(test = poverty > 31.80 & poverty <= 39.88,
                                                        yes = "31.81 to 39.88",
                                                        no = "39.89 to 72.04"))),
         poverty_bands = factor(poverty_bands,
                                levels = c("7.84 to 25.40",
                                           "25.41 to 31.80",
                                           "31.81 to 39.88",
                                           "39.89 to 72.04"))) 
```


Visualização do mapa:
```{r}
shp_centro_oeste_df %>% 
  ggplot() +
  geom_polygon(aes(x = long, y = lat, group = group, fill = poverty_bands),
               color = "black") +
  labs(fill = "Taxa de Pobreza",
       title = "Dist. da Vulnerabilidade Social no CO do Brasil") +
  scale_fill_viridis_d(begin = 1, end = 0, option = "viridis") + 
  theme_update()
```


Visualização do histograma:
```{r}
shp_centro_oeste_df %>% 
  ggplot() +
  geom_histogram(aes(x = poverty, fill = ..count..), color = "white") +
  scale_fill_gradient("Taxa de Pobreza", low = "#FEECE3", high = "#980B13") +
  labs(x = "Taxa de Pobreza",
       y = "Frequência",
       title = "Dist. da Vulnerabilidade Social no CO do Brasil") +
  theme_bw()
```

