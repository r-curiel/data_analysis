---
title: "Concetração de shoppings no Município de São Paulo"
author: "Rafael Vinicius Curiel"
date: "25/01/2022"
output: html_document
---

## Pacotes e comandos

Carregamento dos pacotes  
```{r message=FALSE, warning=FALSE}
pacotes <- c("tidyverse","sf","tmap","rgdal","rgeos","adehabitatHR","knitr","kableExtra")
sapply(pacotes, require, character = T) 
```


## Carregamento do objeto

Carregamento da base de dados
```{r message=FALSE, warning=FALSE}
load("D:/datasets/shoppings.RData")
```



### Exploração

Visão estrutural:
```{r}
shoppings %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped", 
                full_width = TRUE, 
                font_size = 12)
```


Criação de um siplefeature a partir do dataset - georreferenciamento:
```{r}
sf_shoppings <- st_as_sf(x = shoppings, 
                         coords = c("longitude", "latitude"), 
                         crs = 4326)
```


Visualização gráfica preliminar:
```{r warning=FALSE}
tm_shape(shp = sf_shoppings) + 
  tm_dots(size = 1)
```


Visualização do Coordinate Reference System:
```{r warning=FALSE}
attr(sf_shoppings$geometry, which = "crs")
```


Visualização das dimensões do objeto:
```{r}
attr(sf_shoppings$geometry, which = "bbox")
```


Visualização do georreferenciamento:
```{r}
tm_shape(shp = sf_shoppings) + 
  tm_dots(col = "deepskyblue4", 
          border.col = "black", 
          size = 0.2, 
          alpha = 0.8)
```



### Manipulação - Regiões

Carregamento de objeto: dados complementares do município de São Paulo:
```{r message=FALSE, warning=FALSE}
shp_sp <- readOGR("D:/datasets/shapefile_municipio", "municipio_sp")
```


Visualização combinada dos objetos - Por região:
```{r}
tm_shape(shp = shp_sp) + 
  tm_borders(alpha = 0.5) +
  tm_shape(shp = sf_shoppings) + 
  tm_dots(col = "regiao", 
          size = 0.2)
```



### Manipulação - Área de abrangência

Isolamento das coordenadas:
```{r}
coordenadas_shoppings <- cbind(shoppings$longitude,
                               shoppings$latitude)
```


Conversão da base de dados em spatialpoints:
```{r}
sp_shp <- SpatialPoints(coords = coordenadas_shoppings,
                              proj4string = CRS("+proj=longlat"))
```


Orientação a partir de distância eoclidiana:
```{r}
shoppings_UTM <- spTransform(x = sp_shp,
                             CRSobj = CRS("+init=epsg:22523"))
```


Delimitação do raio de abrangência (1,5km):
```{r}
buffer_shoppings <- gBuffer(spgeom = shoppings_UTM, 
                            width = 1500, 
                            byid = TRUE)
```


Visualização gráfica preliminar:
```{r}
tm_shape(shp = buffer_shoppings) + 
  tm_borders()
```



### Visualização

Apresentação dos objetos combinados (georreferenciamento, agrupamento e buffering):
```{r}
tm_shape(shp = shp_sp) + 
  tm_borders(alpha = 0.5) +
  tm_shape(shp = sf_shoppings) + 
  tm_dots(col = "regiao", 
          size = 0.02) +
  tm_shape(buffer_shoppings) + 
  tm_borders(col = "black") 
```



### União da área de abrangência

União da área de abrangência de cada localização: 
```{r}
buffer_union <- gUnaryUnion(spgeom = buffer_shoppings)


tm_shape(shp = shp_sp) + 
  tm_borders(alpha = 0.5) +
  tm_shape(shp = sf_shoppings) + 
  tm_dots(col = "regiao", 
          size = 0.2) +
  tm_shape(shp = buffer_union) + 
  tm_borders(col = "black") + 
  tm_fill(col = "gray",
          alpha = 0.5)
```



### Densidade e Concentração

Criação de um objeto com spatial points + base de dados atrelada:
```{r}
shoppings_sp_df <- SpatialPointsDataFrame(data = shoppings,
                                          coords = coordenadas_shoppings,
                                          proj4string = CRS("+proj=longlat"))
```


Criação da camada de densidade e visualização gráfica preliminar:
```{r message=FALSE, warning=FALSE}
shoppings_dens <- kernelUD(xy = shoppings_sp_df,
                           h = "href",
                           grid = 1000,
                           boundary = NULL)
plot(shoppings_dens)
```


Definição das zonas de densidade:
```{r}
zona1 <- getverticeshr(x = shoppings_dens, percent = 20) 
zona2 <- getverticeshr(x = shoppings_dens, percent = 40) 
zona3 <- getverticeshr(x = shoppings_dens, percent = 60) 
zona4 <- getverticeshr(x = shoppings_dens, percent = 80)
```


### Visualização com densidade:
```{r}
tm_shape(shp = shp_sp) + 
  tm_fill(col = "gray90") + 
  tm_borders(col = "white", alpha = 0.5) + 
  tm_shape(shp = shoppings_sp_df) + 
  tm_dots(col = "regiao", size = 0.25) + 
  tm_shape(zona1) + 
  tm_borders(col = "firebrick4", lwd = 2.5) +
  tm_fill(alpha = 0.4, col = "firebrick4") + 
  tm_shape(zona2) + 
  tm_borders(col = "firebrick3", lwd = 2.5) + 
  tm_fill(alpha = 0.3, col = "firebrick3") + 
  tm_shape(zona3) + 
  tm_borders(col = "firebrick2", lwd = 2.5) + 
  tm_fill(alpha = 0.2, col = "firebrick2") +
  tm_shape(zona4) + 
  tm_borders(col = "firebrick1", lwd = 2.5) + 
  tm_fill(alpha = 0.1, col = "firebrick1")
```

