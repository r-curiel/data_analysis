---
title: "Incidência de casos de Covid-19 por faixa de renda"
author: "Rafael Vinicius Curiel"
date: "13/12/2021"
output:
  html_document: default
  word_document: default
---

## Pacotes e comandos

```{r}
library(tidyverse)
library(readxl)
```



## Covid-19

Dataset Covid-19 em csv com títulos, delimitador em vírgula e valores decimais com ponto:
```{r}
dataset <- utils::read.csv('D:/datasets/covid.csv', 
                    header = TRUE, 
                    sep = ",", 
                    dec = ".")
```



### Exploração

Visão estrutural:
```{r}
dplyr::glimpse(dataset)
```


### Limpeza

Renomear colunas:
```{r}
dataset <- dataset %>% dplyr::rename(Localidade=1,
                             Região=2,
                             case_total=3,
                             case_relative=4,
                             case_week=5,
                             case_week_relative=6,
                             case_day=7,
                             death_total=8,
                             death_relative=9,
                             death_week=10,
                             death_week_relative=11,
                             death_day=12,
                             Transmissão=13)
```


Remoção dos índices 'Global' e 'Others':
```{r}
dataset <- dataset[-c(1),]
dataset <- dataset[!(dataset$Região=='Other'),]
```


Renomear valores de transmissão e criação da variável grupos por quartil:
```{r}
dataset <- dataset %>% dplyr::mutate(Transmissão = dplyr::recode(Transmissão,
                                                              "Clusters of cases" = "cluster_case",
                                                              "Community transmission" = "com_transm",
                                                              "No cases" = "no_case",
                                                              "Pending" = "pend",
                                                              "Sporadic cases" = "spor_case")) %>% 
                      dplyr::mutate(Grupo = base::cut(case_relative, 
                                         base::c(-Inf, 
                                           stats::quantile(dataset$case_relative, 
                                           type=5, 
                                           probs = c(0.25, 0.50, 0.75),
                                           TRUE),
                                           Inf),
                                         base::c('First_quant', 
                                           'Second_quant', 
                                           'Third_quant', 
                                           'Fourth_quant')))  
```


Reposicionamento de grupo e remoção de mortes:
```{r}
dataset <- dataset %>% dplyr::select('Localidade', 'Região', 'Grupo', dplyr::everything(), -'death_day')
```



### Resumo estatístico

Por quartil:
```{r}
g_quant <- dataset %>% dplyr::group_by(Grupo) %>%
                       dplyr::summarise(Média=base::mean(case_relative, na.rm = T),
                                'Desvio Padrão'=stats::sd(case_relative, na.rm = T),
                                Observações=dplyr::n()) %>%
                       dplyr::ungroup() %>% base::droplevels(.)

g_quant
```


Por região:
```{r}
g_region <- dataset %>% group_by(Região) %>%
                       summarise(Média=mean(case_relative, na.rm = T),
                                'Desvio Padrão'=sd(case_relative, na.rm = T),
                                Observações=n(),
                                '%perc'=(round(n()/nrow(dataset)*100,2))) %>%
                       ungroup () %>% droplevels(.)

g_region
```


Por transmissão:
```{r}
g_transmission <- dataset %>% group_by(Transmissão) %>%
                       summarise(Média=mean(case_relative, na.rm = T),
                                'Desvio Padrão'=sd(case_relative, na.rm = T),
                                Observações=n(),
                                '%perc'=(round(n()/nrow(dataset)*100,2))) %>%
                       ungroup () %>% droplevels(.)

g_transmission
```



## PIB per capta

Dataset WBD PIB per capta em xls.
```{r}
pib <- readxl::read_excel('D:/datasets/wbd_income.xls')
```



### Exploração

Visão estrutural:
```{r}
glimpse(pib)
```


### Limpeza

Renomear colunas:
```{r}
pib <- pib %>% rename(Localidade=1,
                     c_code=2,
                     income=3)
```



## Covid-19 e PIB

### Combinação das bases

Combinação da base de dados
```{r}
dataset2 <- pib %>% dplyr::right_join(dataset, by ="Localidade") %>%
                    dplyr::select(everything(), -c('c_code', '2019')) %>%
                    dplyr::mutate(income = dplyr::recode(income,
                                          "High income" = "1 - High",
                                          "Low income" = "4 - Low",
                                          "Lower middle income" = "3 - L_Middle",
                                          "Upper middle income" = "2 - H_Middle"))
```



## Resultados

### Gráfico resumido de casos por faixa de renda
```{r}
dataset2 %>% group_by(income) %>%
             summarise(Média=mean(case_relative, na.rm = T),
                       'Desvio Padrão'=sd(case_relative, na.rm = T),
                       Observações=n(),
                       '%perc'=(round(n()/nrow(dataset2)*100,2))) %>%
                       ungroup () %>% droplevels(.) %>%
  ggplot(aes(x=income, y=Média, fill=income)) + 
    geom_bar(stat="identity", position = position_dodge(width = 0.7)) + 
    geom_text(aes(label=round(Média)), position=position_dodge(width=0.9), vjust=-0.25, size = 3) +
    labs(x = "Faixa de Renda",
         y = "Média de Casos Relativos",
         title = "Análise de casos de Covid-19 por Faixa de Renda")
```