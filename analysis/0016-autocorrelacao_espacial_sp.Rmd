---
title: "Técnicas para Verificação da Autocorrelação Espacial"
author: "Rafael Vinicius Curiel"
date: "10/02/2022"
output: html_document
---

## Pacotes e comandos

Carregamento dos pacotes  
```{r message=FALSE, warning=FALSE}
pacotes <- c("tidyverse","rgdal","spdep","knitr","kableExtra","tmap","gtools")
sapply(pacotes, require, character = T) 
```


## Carregamento do objeto

Carregamento da base de dados
```{r message=FALSE, warning=FALSE}
shp_sp <- rgdal::readOGR(dsn = "D:/datasets/shapefile_sp", layer = "estado_sp")

base::load("D:/datasets/dados_sp.RData")
```



### Manipulação

União das bases de dados
```{r}
shp_sp@data %>% 
  dplyr::rename(codigo = 2) %>% 
  dplyr::mutate(codigo = base::as.numeric(codigo)) %>% 
  dplyr::left_join(dados_sp, by = "codigo") -> shp_sp@data

head(shp_sp@data, 3)
```


Estabelecimento do critério de vizinhança:
```{r}
nb_queen <- spdep::poly2nb(pl = shp_sp,
                           queen = TRUE,
                           row.names = shp_sp@data$NM_MUNICIP)
```


Matriz W:
```{r}
w_matrix_queen <- spdep::nb2mat(neighbours = nb_queen,
                                style = "B",
                                zero.policy = TRUE) # (desconsidera ilha)
colnames(w_matrix_queen) <- shp_sp@data$NM_MUNICIP
```


Matriz W para Lista
```{r}
w_list_queen <- spdep::mat2listw(w_matrix_queen)
```



### Visualização

Visualização gráfica preliminar da distribuição do IDH:
```{r}
tm_shape(shp = shp_sp) +
  tm_fill(col = "idh", style = "quantile", n = 5, palette = "viridis", title = "IDH") +
  tm_layout(legend.text.size = 0.7,
            legend.title.size = 0.9,
            main.title = "Distribuição do IDH nos Municípios de SP") +
  tm_borders()
```



## Autocorrelação Espacial
(Verifica se existe a autocorrelação espacial envolvendo o fenômeno estudado.)


### Autocorrelação Global - Estatística I de Moran:

```{r}
spdep::moran.test(x = shp_sp@data$idh, listw = w_list_queen, zero.policy = TRUE)
```
Observado Autocorrelação do tipo positiva (I de Moran > Esperado)
Revela que: observações com alto IDH estão próximas outras observações com alto IDH.
            O mesmo ocorre para observações com baixo IDH.


Diagrama:
```{r}
moran.plot(x = shp_sp@data$idh, 
           listw = w_list_queen, 
           zero.policy = TRUE,
           xlab = "IDH", 
           ylab = "IDH Espacialmente Defasado",
           pch = 19)
```


### Autocorrelação Local de Moran:

Padronização em linha:
```{r}
w_matrix_queen_linha <- spdep::nb2mat(nb_queen, style = "W", zero.policy = TRUE)

list_w_queen <- spdep::mat2listw(w_matrix_queen_linha)
```


Criação da Moran Local:
```{r}
moran_local <- spdep::localmoran(x = shp_sp@data$idh, listw = list_w_queen, zero.policy = TRUE)

moran_local_map <- base::cbind(shp_sp, moran_local)
```


Visualização Espacial:
```{r}
# Ajustes da legenda:
raster::quantile(moran_local_map@data$Ii, type = 5, probs = c(0,0.2,0.4,0.6,0.8))

moran_local_map@data <- moran_local_map@data %>% 
    dplyr::mutate(faixa_quantis = base::factor(quantcut(x = Ii, q = 5))) 

# Visualização
tm_shape(shp = moran_local_map) +
    tm_fill(col = "faixa_quantis", palette = "RdYlBu", title = "Faixas") +
    tm_layout(legend.text.size = 0.7,
            legend.title.size = 0.9,
            main.title = "Faixa de Quantis do IDH do Estado de São Paulo") +
    tm_borders()
```


Plotagem demonstrando os quadrantes:
```{r}
moran_local_map <- base::cbind(moran_local_map, 
                               base::attr(x = moran_local, which = "quadr")[1])

tm_shape(shp = moran_local_map) +
  tm_fill(col = "mean", palette = "viridis", title = "Quadrantes") +
  tm_layout(legend.text.size = 0.7,
            legend.title.size = 0.9,
            main.title = "Quadrantes de Autocor. Espacial Local de Moran",
            main.title.position = 'center') +

  tm_borders()
```


### Clusterização LISA - Local Indicators of Spatial Association:
(Iidentifica padrões locais de associação espacial)

Geração dos quadrantes:
```{r}
quadrantes <- base::vector(mode = "numeric", length = nrow(moran_local))
```


Centro dos valores do IDH ao redor da média:
```{r}
centro_idh <- shp_sp@data$idh - base::mean(shp_sp@data$idh)
```


Centro dos valores da Moran Local ao redor da média:
```{r}
centro_moran_local <- moran_local[,1] - base::mean(moran_local[,1])
```


Significância a ser adotada:
```{r}
sig <- 0.05
```


Enquadramento das observações:
```{r}
quadrantes[centro_idh > 0 & centro_moran_local > 0] <- "HH"
quadrantes[centro_idh > 0 & centro_moran_local < 0] <- "HL"
quadrantes[centro_idh < 0 & centro_moran_local > 0] <- "LH"
quadrantes[centro_idh < 0 & centro_moran_local < 0] <- "LL"
```


Eliminação das observações sem significância estatística:
```{r}
quadrantes[moran_local[,5] > sig] <- "Estatisticamente Não Significante"
```


União dos objetos:
```{r}
moran_local_map@data["Quadrantes"] <- base::factor(quadrantes)
```


Visualização gráfica:
```{r}
tm_shape(shp = moran_local_map) +
  tm_polygons(col = "Quadrantes", 
              pal = c(HH = "#FDE725FF",
                      HL = "#35B779FF", 
                      LH = "#31688EFF", 
                      LL = "#440154FF",
                      "Estatisticamente Não Significante" = "gray")) +
  tm_layout(main.title = "LISA do IDH no Estado de SP",
            main.title.position = 'center') +
  tm_borders()
```

